#!/usr/bin/env bash
#MISE description="Create a new release (updates changelog, tags, and pushes)"
#USAGE arg "<version>" help="Version to release (e.g., 0.2.0)"
set -euo pipefail

VERSION="${usage_version}"

# Validate version format
if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "Error: Version must be in format X.Y.Z (e.g., 0.2.0)"
    exit 1
fi

TAG="v${VERSION}"

# Check if tag already exists
if git rev-parse "$TAG" >/dev/null 2>&1; then
    echo "Error: Tag $TAG already exists"
    exit 1
fi

# Check for uncommitted changes
if ! git diff --quiet || ! git diff --cached --quiet; then
    echo "Error: You have uncommitted changes. Please commit or stash them first."
    exit 1
fi

echo "Preparing release $TAG..."

# Generate changelog for this release
git-cliff --tag "$TAG" -o CHANGELOG.md

# Commit the changelog
git add CHANGELOG.md
git commit -m "chore(release): prepare $TAG"

# Create and push tag
git tag -a "$TAG" -m "Release $TAG"

echo ""
echo "Release $TAG prepared successfully!"
echo ""
echo "Next steps:"
echo "  git push origin main --tags    # Push to trigger GitHub Actions release"
echo ""
echo "Or to undo:"
echo "  git tag -d $TAG && git reset --hard HEAD~1"
